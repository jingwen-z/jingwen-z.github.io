<!DOCTYPE html><html lang="en">
  <head><!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-85831520-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-85831520-1');
		
	</script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>How to apply mock with python unittest module? - Jingwen Zheng</title>

<meta name="description" content="This blog talks about how to apply mock with python unittest module, like use &quot;unittest.mock&quot; to simulate the behavior of complex or real objects, ...">

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>How to apply mock with python unittest module? | Jingwen Zheng</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="How to apply mock with python unittest module?" />
<meta name="author" content="Jingwen Zheng" />
<meta property="og:locale" content="en" />
<meta name="description" content="This blog talks about how to apply mock with python unittest module, like use “unittest.mock” to simulate the behavior of complex or real objects, configure your mock instance with “return_value” or / and “side_effect”, check how you called a method with assertions and mock an object with “patch()”." />
<meta property="og:description" content="This blog talks about how to apply mock with python unittest module, like use “unittest.mock” to simulate the behavior of complex or real objects, configure your mock instance with “return_value” or / and “side_effect”, check how you called a method with assertions and mock an object with “patch()”." />
<link rel="canonical" href="https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/" />
<meta property="og:url" content="https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/" />
<meta property="og:site_name" content="Jingwen Zheng" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-16T22:11:20+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How to apply mock with python unittest module?" />
<meta name="twitter:site" content="@Jingwen_QI" />
<meta name="twitter:creator" content="@Jingwen Zheng" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Jingwen Zheng"},"description":"This blog talks about how to apply mock with python unittest module, like use “unittest.mock” to simulate the behavior of complex or real objects, configure your mock instance with “return_value” or / and “side_effect”, check how you called a method with assertions and mock an object with “patch()”.","@type":"BlogPosting","headline":"How to apply mock with python unittest module?","dateModified":"2020-07-16T22:11:20+02:00","datePublished":"2020-07-16T22:11:20+02:00","url":"https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/","mainEntityOfPage":{"@type":"WebPage","@id":"https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<!-- Extra Open Graph :: Start -->

<!-- Extra Open Graph :: End -->

<link rel="canonical" href="https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/"><link rel="alternate" type="application/rss+xml" title="Jingwen Zheng" href="/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"><link rel="manifest" href="/assets/site.webmanifest"><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: '/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>

          <a title="Data Science Enthusiast
" href="/">Jingwen Zheng</a>
        </div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="/portfolio">Portfolio</a></li><li class="navigation__item"><a href="/series">Series</a></li><li class="navigation__item"><a href="/archive">Archive</a></li><li class="navigation__item"><a href="/about">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class="article__header--overlay"><div class="hero hero--dark overlay" style="background-image:linear-gradient(135deg, rgba(0, 0, 0, .6), rgba(0, 0, 0, .4)),url(/images/20200716-python-mock.png);background-color:#203028;"><div class="hero__content"><div class ="main"><div class="article__info clearfix">
      <ul class="left-col menu">
        <li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=python3">python3</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=unittest">unittest</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="/archive?tag=mock">mock</a>
            </li>

      <li class="separator">|</li>
        
          <li>
            <a class="button button--circle button--primary focus lang"
               href="/how-to-apply-mock-with-python-unittest-module/"><span>EN</span></a>

            






            

            
          </li>
        
      
    </ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Jul 16, 2020</span>
            </li></ul></div><div class="article__header"><header><h1>How to apply mock with python unittest module?</h1></header></div><p class="overlay__excerpt">This blog talks about how to apply mock with python unittest module, like use "unittest.mock" to simulate the behavior of complex or real objects, configure your mock instance with "return_value" o...</p></div></div>
              </div>
            </div><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><meta itemprop="headline" content="How to apply mock with python unittest module?"><meta itemprop="author" content="Jingwen Zheng"/><meta itemprop="datePublished" content="2020-07-16T22:11:20+02:00">
    <meta itemprop="keywords" content="python3,unittest,mock"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><p>Imagine that when we wrote a Python class to extract some business places’
reviews with Google Place API, how could we ensure that we will extract the data
correctly without sending requests to Google? In this case, we can use python
module <code class="language-plaintext highlighter-rouge">unittest</code> to mock a <code class="language-plaintext highlighter-rouge">requests.get</code> and to test if we will get the
expectant result. In this blog, I will introduce python mock object with the
following point:</p>
<ul>
  <li>What is mock?</li>
  <li>Why we use mock?</li>
  <li>Python mock library</li>
  <li>The mock object</li>
  <li>Usecases</li>
</ul>

<h2 id="what-is-mock">What is mock?</h2>
<p>In object-oriented programming, mock objects are simulated objects that mimic
the behavior of real objects in controlled ways, most often as part of a
software testing initiative. A programmer typically creates a mock object to
test the behavior of some other object, in much the same way that a car designer
uses a crash test dummy to simulate the dynamic behavior of a human in vehicle
impacts.</p>

<h2 id="why-we-use-mock">Why we use mock?</h2>
<p>In a unit test, mock objects can simulate the behavior of complex, real objects
and are therefore useful when a real object is impractical or impossible to
incorporate into a unit test. If an object has any of the following
characteristics, it may be useful to use a mock object in its place:</p>
<ul>
  <li>the object supplies non-deterministic results (e.g. the current time or the
current temperature)</li>
  <li>it has states that are difficult to create or reproduce (e.g. a network error)</li>
  <li>it is slow (e.g. a complete database, which would have to be initialized
before the test)</li>
  <li>it does not yet exist or may change behavior</li>
  <li>it would have to include information and methods exclusively for testing
purposes (and not for its actual task)</li>
</ul>

<p>For example, an alarm clock program that causes a bell to ring at a certain
time might get the current time from a time service. To test this, the test must
wait until the alarm time to know whether it has rung the bell correctly. If a
mock time service is used in place of the real-time service, it can be
programmed to provide the bell-ringing time (or any other time) regardless of
the real-time, so that the alarm clock program can be tested in isolation.</p>

<h2 id="python-mock-library">Python mock library</h2>
<p>From this section, I’ll talk about mock with <code class="language-plaintext highlighter-rouge">unittest.mock</code> library.</p>

<p><code class="language-plaintext highlighter-rouge">unittest.mock</code> is a library for testing in Python. It allows you to replace
parts of your system under test with mock objects and make assertions about how
they have been used.</p>

<p><code class="language-plaintext highlighter-rouge">unittest.mock</code> provides a core <code class="language-plaintext highlighter-rouge">Mock</code> class removing the need to create a host
of stubs throughout your test suite. After acting, you can make assertions about
which methods/attributes were used and the arguments they were called with. You
can also specify return values and set needed attributes in the normal way.</p>

<p>Additionally, mock provides a <code class="language-plaintext highlighter-rouge">patch()</code> decorator that handles patching module
and class level attributes within the scope of a test.</p>

<p>Mock is based on the ‘action -&gt; assertion’ pattern instead of ‘record -&gt; replay’
used by many mocking frameworks.</p>

<h2 id="the-mock-object">The mock object</h2>
<h3 id="the-mock-class">The Mock Class</h3>
<p><code class="language-plaintext highlighter-rouge">unittest.mock</code> offers a base class for mocking objects called <code class="language-plaintext highlighter-rouge">Mock</code>. <code class="language-plaintext highlighter-rouge">Mock</code> is
a flexible mock object intended to replace the use of stubs and test doubles
throughout your code. Mocks are callable and create attributes as new mocks when
you access them. Accessing the same attribute will always return the same mock.
Mocks record how you use them, allowing you to make assertions about what your
code has done to them.</p>

<p>We can create a <code class="language-plaintext highlighter-rouge">mock</code> instance as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">Mock</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="nb">id</span><span class="o">=</span><span class="s">'4448647264'</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Moreover, we can also specify parameters’ values like <code class="language-plaintext highlighter-rouge">return_value</code>:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">return_value</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">3</span>
</code></pre></div></div>

<h3 id="configure-the-returned-value-with-return_value">Configure the returned value with <code class="language-plaintext highlighter-rouge">return_value</code></h3>
<p>We can set <code class="language-plaintext highlighter-rouge">return_value</code> to configure the value returned by calling the mock:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s">'fish'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="s">'fish'</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">return_value</code> can also be set in the constructor:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">return_value</span>
<span class="mi">3</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="mi">3</span>
</code></pre></div></div>

<h3 id="configure-the-raising-exceptions-with-side_effect">Configure the raising exceptions with <code class="language-plaintext highlighter-rouge">side_effect</code></h3>
<p>This can either be a function to be called when the mock is called, an iterable
or an exception (class or instance) to be raised.</p>

<p>If you pass in a function it will be called with the same arguments as the mock
and unless the function returns the <code class="language-plaintext highlighter-rouge">DEFAULT</code> singleton the call to the mock will
then return whatever the function returns. If the function returns <code class="language-plaintext highlighter-rouge">DEFAULT</code>
then the mock will return its normal value (from the <code class="language-plaintext highlighter-rouge">return_value</code>).</p>

<p>If you pass in an iterable, it is used to retrieve an iterator which must yield
a value on every call. This value can either be an exception instance to be
raised or a value to be returned from the call to the mock (<code class="language-plaintext highlighter-rouge">DEFAULT</code> handling
is identical to the function case).</p>

<p>An example of a mock that raises an exception (to test exception handling of an
API):</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Boom!'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="p">...</span>
<span class="nb">Exception</span><span class="p">:</span> <span class="n">Boom</span><span class="err">!</span>
</code></pre></div></div>

<p>Using <code class="language-plaintext highlighter-rouge">side_effect</code> to return a sequence of values:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(),</span> <span class="n">mock</span><span class="p">(),</span> <span class="n">mock</span><span class="p">()</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="assertions">Assertions</h3>
<p>Mock instances store data on how you used them. For example, you can see if you
called a method, how you called it, etc.</p>

<h4 id="assert_called"><code class="language-plaintext highlighter-rouge">assert_called()</code></h4>
<p>Assert that the mock was called at least once.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.method()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">assert_called</span><span class="p">()</span>
</code></pre></div></div>

<h4 id="assert_called_once"><code class="language-plaintext highlighter-rouge">assert_called_once()</code></h4>
<p>Assert that the mock was called exactly once.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.method()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.method()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">assert_called_once</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="p">...</span>
<span class="nb">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="s">'method'</span> <span class="n">to</span> <span class="n">have</span> <span class="n">been</span> <span class="n">called</span> <span class="n">once</span><span class="p">.</span> <span class="n">Called</span> <span class="mi">2</span> <span class="n">times</span><span class="p">.</span>
</code></pre></div></div>

<h4 id="assert_called_withargs-kwargs"><code class="language-plaintext highlighter-rouge">assert_called_with(*args, **kwargs)</code></h4>
<p>This method is a convenient way of asserting that the last call has been made in
a particular way:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s">'wow'</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.method()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s">'wow'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="assert_called_once_withargs-kwargs"><code class="language-plaintext highlighter-rouge">assert_called_once_with(*args, **kwargs)</code></h4>
<p>Assert that the mock was called exactly once and that that call was with the
specified arguments.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">'baz'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">'baz'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="s">'other'</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">'values'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s">'other'</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">'values'</span><span class="p">)</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="p">...</span>
<span class="nb">AssertionError</span><span class="p">:</span> <span class="n">Expected</span> <span class="s">'mock'</span> <span class="n">to</span> <span class="n">be</span> <span class="n">called</span> <span class="n">once</span><span class="p">.</span> <span class="n">Called</span> <span class="mi">2</span> <span class="n">times</span><span class="p">.</span>
</code></pre></div></div>

<h3 id="calling">Calling</h3>
<p>Mock objects are callable. The call will return the value set as the
<code class="language-plaintext highlighter-rouge">return_value</code> attribute. The default return value is a new Mock object; it is
created the first time the return value is accessed (either explicitly or by
calling the Mock) - but it is stored and the same one returned each time.</p>

<p>Calls made to the object will be recorded in the attributes like <code class="language-plaintext highlighter-rouge">call_args</code> and
<code class="language-plaintext highlighter-rouge">call_args_list</code>.</p>

<h4 id="call_args"><code class="language-plaintext highlighter-rouge">call_args</code></h4>
<p>This is either <code class="language-plaintext highlighter-rouge">None</code> (if the mock hasn’t been called), or the arguments that
the mock was last called with.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">mock</span><span class="p">.</span><span class="n">call_args</span><span class="p">)</span>
<span class="bp">None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span>
<span class="n">call</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span> <span class="o">==</span> <span class="p">()</span>
<span class="bp">True</span>
</code></pre></div></div>

<p>This will be in the form of a tuple: the first member, which can also be
accessed through the args property, is any ordered arguments the mock was called
with (or an empty tuple) and the second member, which can also be accessed
through the kwargs property, is any keyword arguments (or an empty dictionary).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span>
<span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span> <span class="o">==</span> <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),)</span>
<span class="bp">True</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span><span class="p">.</span><span class="n">args</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span><span class="p">.</span><span class="n">kwargs</span>
<span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'fish'</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="s">'w00t!'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span>
<span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'fish'</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="s">'w00t!'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span><span class="p">.</span><span class="n">args</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args</span><span class="p">.</span><span class="n">kwargs</span>
<span class="p">{</span><span class="s">'key'</span><span class="p">:</span> <span class="s">'fish'</span><span class="p">,</span> <span class="s">'next'</span><span class="p">:</span> <span class="s">'w00t!'</span><span class="p">}</span>
</code></pre></div></div>

<h4 id="call_args_list"><code class="language-plaintext highlighter-rouge">call_args_list</code></h4>
<p>This is a list of all the calls made to the mock object in sequence (so the
length of the list is the number of times it has been called). Before any calls
have been made it is an empty list. The <code class="language-plaintext highlighter-rouge">call</code> object can be used for
conveniently constructing lists of calls to compare with <code class="language-plaintext highlighter-rouge">call_args_list</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">'fish'</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="s">'w00t!'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args_list</span>
<span class="p">[</span><span class="n">call</span><span class="p">(),</span> <span class="n">call</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">call</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">'fish'</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="s">'w00t!'</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">[(),</span> <span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),),</span> <span class="p">({</span><span class="s">'key'</span><span class="p">:</span> <span class="s">'fish'</span><span class="p">,</span> <span class="s">'next'</span><span class="p">:</span> <span class="s">'w00t!'</span><span class="p">},)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">call_args_list</span> <span class="o">==</span> <span class="n">expected</span>
<span class="bp">True</span>
</code></pre></div></div>

<h4 id="method_calls"><code class="language-plaintext highlighter-rouge">method_calls</code></h4>
<p>As well as tracking calls to themselves, mocks also track calls to methods and
attributes, and <em>their</em> methods and attributes:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.method()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="nb">property</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">attribute</span><span class="p">()</span>
<span class="o">&lt;</span><span class="n">Mock</span> <span class="n">name</span><span class="o">=</span><span class="s">'mock.property.method.attribute()'</span> <span class="nb">id</span><span class="o">=</span><span class="s">'...'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mock</span><span class="p">.</span><span class="n">method_calls</span>
<span class="p">[</span><span class="n">call</span><span class="p">.</span><span class="n">method</span><span class="p">(),</span> <span class="n">call</span><span class="p">.</span><span class="nb">property</span><span class="p">.</span><span class="n">method</span><span class="p">.</span><span class="n">attribute</span><span class="p">()]</span>
</code></pre></div></div>

<h3 id="patch">patch()</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unittest</span><span class="p">.</span><span class="n">mock</span><span class="p">.</span><span class="n">patch</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">DEFAULT</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">spec_set</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">autospec</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">patch()</code> acts as a function decorator, class decorator, or a context manager.
Inside the body of the function or with a statement, the <em>target</em> is patched with
a <em>new</em> object. When the function/with statement exits the patch is undone.</p>

<p><em>target</em> should be a string in the form <code class="language-plaintext highlighter-rouge">'package.module.ClassName'</code>. The
<em>target</em> is imported and the specified object replaced with the new object, so
the <em>target</em> must be importable from the environment you are calling <code class="language-plaintext highlighter-rouge">patch()</code>
from. The target is imported when the decorated function is executed, not at
decoration time.</p>

<h4 id="3-ways-to-apply-the-mock-with-patch">3 ways to apply the mock with <code class="language-plaintext highlighter-rouge">patch()</code></h4>
<ul>
  <li>Decorator
If you want to mock an object for the duration of your entire test function,
you can use <code class="language-plaintext highlighter-rouge">patch()</code> as a function decorator.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">Timeout</span>

<span class="kn">import</span> <span class="nn">learn_unittest_mock.learn_mock</span>


<span class="k">class</span> <span class="nc">PatchDecoratorTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="o">@</span><span class="n">patch</span><span class="p">(</span><span class="s">'learn_unittest_mock.learn_mock.requests'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_get_holiday</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_requests</span><span class="p">):</span>
        <span class="n">mock_requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">Timeout</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="n">learn_unittest_mock</span><span class="p">.</span><span class="n">learn_mock</span><span class="p">.</span><span class="n">get_holidays</span><span class="p">()</span>

        <span class="n">mock_requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">assert_called_once</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>Context manager
You only want to mock an object for a part of the test scope. You are already
using too many decorators or parameters, which hurts your test’s readability.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">Timeout</span>

<span class="kn">import</span> <span class="nn">learn_unittest_mock.learn_mock</span>


<span class="k">class</span> <span class="nc">PatchContextManagerTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s">'learn_unittest_mock.learn_mock.requests'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_requests</span><span class="p">:</span>
            <span class="n">mock_requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">Timeout</span>
            <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Timeout</span><span class="p">):</span>
                <span class="n">learn_unittest_mock</span><span class="p">.</span><span class="n">learn_mock</span><span class="p">.</span><span class="n">get_holidays</span><span class="p">()</span>

            <span class="n">mock_requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">asser_called_once</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>Inline
This approach is using start and stop on the mock itself to apply the mock
inline. If you need to do a lot of mocking in the test, you will have either
decorators or context managers or a mix of the two, which is ugly or heavy. In
this case you can apply the mock in “inline” approach.</li>
</ul>

<p>All the patchers have <code class="language-plaintext highlighter-rouge">start()</code> and <code class="language-plaintext highlighter-rouge">stop()</code> methods. These make it simpler to
do patching in <code class="language-plaintext highlighter-rouge">setUp</code> methods or where you want to do multiple patches without
nesting decorators or with statements.</p>

<p>To use them call <code class="language-plaintext highlighter-rouge">patch()</code>, <code class="language-plaintext highlighter-rouge">patch.object()</code> or <code class="language-plaintext highlighter-rouge">patch.dict()</code> as normal and
keep a reference to the returned <code class="language-plaintext highlighter-rouge">patcher</code> object. You can then call <code class="language-plaintext highlighter-rouge">start()</code>
to put the patch in place and <code class="language-plaintext highlighter-rouge">stop()</code> to undo it. If you are using <code class="language-plaintext highlighter-rouge">patch()</code>
to create a mock for you then it will be returned by the call to <code class="language-plaintext highlighter-rouge">patcher.start</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">Timeout</span>

<span class="kn">import</span> <span class="nn">learn_unittest_mock.learn_mock</span>


<span class="k">class</span> <span class="nc">PatchInlineTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="p">(</span><span class="s">'learn_unittest_mock.learn_mock.requests'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_get_holiday</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">learn_unittest_mock</span><span class="p">.</span><span class="n">learn_mock</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">Timeout</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="n">learn_unittest_mock</span><span class="p">.</span><span class="n">learn_mock</span><span class="p">.</span><span class="n">get_holidays</span><span class="p">()</span>

        <span class="n">learn_unittest_mock</span><span class="p">.</span><span class="n">learn_mock</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">assert_called_once</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="usecases">Usecases</h2>
<h3 id="mocking-sending-requests-with-google-places-api">Mocking sending requests with Google Places API</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># learn_unittest_mock/google_place_api.py
</span><span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="k">class</span> <span class="nc">Place</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">place_name</span><span class="p">,</span> <span class="n">place_id</span><span class="p">,</span> <span class="n">glb_rating</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lng</span> <span class="o">=</span> <span class="n">lng</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">place_name</span> <span class="o">=</span> <span class="n">place_name</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">place_id</span> <span class="o">=</span> <span class="n">place_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">glb_rating</span> <span class="o">=</span> <span class="n">glb_rating</span>


<span class="k">def</span> <span class="nf">search_place</span><span class="p">(</span><span class="n">gps</span><span class="o">=</span><span class="s">'gps'</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s">'api_key'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Place</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s">'https://maps.googleapis.com/maps/api/place/nearbysearch/json?'</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span>
            <span class="p">{</span><span class="s">'location'</span><span class="p">:</span> <span class="n">gps</span><span class="p">,</span> <span class="s">'rankby'</span><span class="p">:</span> <span class="s">'distance'</span><span class="p">,</span>
             <span class="s">'name'</span><span class="p">:</span> <span class="s">'La Poste'</span><span class="p">,</span> <span class="s">'key'</span><span class="p">:</span> <span class="n">api_key</span><span class="p">}</span>
        <span class="p">))</span>

    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">resp_json</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">resp_json</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'geometry'</span><span class="p">][</span><span class="s">'location'</span><span class="p">][</span><span class="s">'lat'</span><span class="p">]</span>
        <span class="n">lng</span> <span class="o">=</span> <span class="n">resp_json</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'geometry'</span><span class="p">][</span><span class="s">'location'</span><span class="p">][</span><span class="s">'lng'</span><span class="p">]</span>
        <span class="n">place_name</span> <span class="o">=</span> <span class="n">resp_json</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'name'</span><span class="p">]</span>
        <span class="n">place_id</span> <span class="o">=</span> <span class="n">resp_json</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'place_id'</span><span class="p">]</span>
        <span class="n">glb_rating</span> <span class="o">=</span> <span class="n">resp_json</span><span class="p">[</span><span class="s">'results'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'rating'</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Place</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">,</span> <span class="n">place_name</span><span class="p">,</span> <span class="n">place_id</span><span class="p">,</span> <span class="n">glb_rating</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Place</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="s">'null'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>In the scripts <code class="language-plaintext highlighter-rouge">google_place_api.py</code>, I create a Python class named “<code class="language-plaintext highlighter-rouge">Place</code>”,
which contains one place’s latitude, longitude, name, ID and its rating; then I
create a function <code class="language-plaintext highlighter-rouge">search_place(gps='gps', api_key='api_key')</code> in order to get
places’ information by Google Places API and inject the values into <code class="language-plaintext highlighter-rouge">Place</code>
class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># learn_unittest_mock/google_place_api_test.py
</span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">Mock</span><span class="p">,</span> <span class="n">call</span>

<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">Timeout</span>

<span class="kn">import</span> <span class="nn">learn_unittest_mock.google_place_api</span> <span class="k">as</span> <span class="n">target</span>


<span class="k">class</span> <span class="nc">GooglePlaceApiTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="p">(</span><span class="s">'learn_unittest_mock.google_place_api.requests'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_search_place_side_effect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">Timeout</span>

        <span class="c1"># use .assertRaises() to verify that get_holidays() raises an exception
</span>        <span class="c1"># given the new side effect of get()
</span>        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="n">target</span><span class="p">.</span><span class="n">search_place</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_search_place_return_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response_mock</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">()</span>
        <span class="n">response_mock</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">response_mock</span><span class="p">.</span><span class="n">json</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'results'</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s">'geometry'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s">'location'</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s">'lat'</span><span class="p">:</span> <span class="mf">48.830273</span><span class="p">,</span>
                            <span class="s">'lng'</span><span class="p">:</span> <span class="mf">2.8059952</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="s">'name'</span><span class="p">:</span> <span class="s">'La Poste'</span><span class="p">,</span>
                    <span class="s">'place_id'</span><span class="p">:</span> <span class="s">'abcdefg'</span><span class="p">,</span>
                    <span class="s">'rating'</span><span class="p">:</span> <span class="mi">5</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="p">[</span><span class="n">Timeout</span><span class="p">,</span> <span class="n">response_mock</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Timeout</span><span class="p">):</span>
            <span class="n">target</span><span class="p">.</span><span class="n">search_place</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">search_place</span><span class="p">()</span>

        <span class="c1"># test requests' results
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="mf">48.830273</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">lng</span><span class="p">,</span> <span class="mf">2.8059952</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">place_name</span><span class="p">,</span> <span class="s">'La Poste'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">place_id</span><span class="p">,</span> <span class="s">'abcdefg'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">glb_rating</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

        <span class="c1"># assert that the mock was called at least once
</span>        <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">assert_called</span><span class="p">()</span>

        <span class="c1"># how many times the mock object has been called
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="c1"># test arguments that the mock was last called with
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="s">'https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=gps&amp;rankby=distance&amp;name=La+Poste&amp;key=api_key'</span><span class="p">),</span>
            <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">call_args</span><span class="p">)</span>

        <span class="c1"># list of all the calls made to the mock object in the sequence
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">call</span><span class="p">(</span>
                    <span class="s">'https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=gps&amp;rankby=distance&amp;name=La+Poste&amp;key=api_key'</span><span class="p">),</span>
                <span class="n">call</span><span class="p">(</span>
                    <span class="s">'https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=gps&amp;rankby=distance&amp;name=La+Poste&amp;key=api_key'</span><span class="p">)],</span>
            <span class="n">target</span><span class="p">.</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">call_args_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">google_place_api_test.py</code> scripts, I firstly patch the
<code class="language-plaintext highlighter-rouge">learn_unittest_mock.google_place_api.requests</code>, then create multiple tests:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">test_search_place_side_effect</code>: configure the <code class="language-plaintext highlighter-rouge">side_effect</code> to respond to a
connection timeout.</li>
  <li><code class="language-plaintext highlighter-rouge">test_search_place_return_value</code>: I mock the requests’ return value with
<code class="language-plaintext highlighter-rouge">status_code</code> and <code class="language-plaintext highlighter-rouge">return_value</code>, configure the <code class="language-plaintext highlighter-rouge">side_effect</code> with <code class="language-plaintext highlighter-rouge">[Timeout,
response_mock]</code>. Thus, the first time we call <code class="language-plaintext highlighter-rouge">target.search_place()</code>, it raises
<code class="language-plaintext highlighter-rouge">Timeout</code>, then we call it again and save the results as <code class="language-plaintext highlighter-rouge">res</code>. Next, we can
test if the results are the same as we set with <code class="language-plaintext highlighter-rouge">self.assertEqual</code>; test if the
mock object was called at least once with <code class="language-plaintext highlighter-rouge">assert_called()</code>; test if the mock
has been called twice; test arguments that the mock was last called with and the
list of all the calls mode to the mock in sequence.</li>
</ul>

<h3 id="mocking-generating-dates">Mocking generating dates</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># learn_unittest_mock/dates_generator.py
</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>

<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>


<span class="k">class</span> <span class="nc">StartEndDates</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_week_start</span><span class="p">,</span> <span class="n">last_week_end</span><span class="p">,</span> <span class="n">last_month_start</span><span class="p">,</span>
                 <span class="n">last_month_end</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_week_start</span> <span class="o">=</span> <span class="n">last_week_start</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_week_end</span> <span class="o">=</span> <span class="n">last_week_end</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_month_start</span> <span class="o">=</span> <span class="n">last_month_start</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">last_month_end</span> <span class="o">=</span> <span class="n">last_month_end</span>


<span class="k">def</span> <span class="nf">start_end_dates</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">StartEndDates</span><span class="p">:</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now_wkday</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">weekday</span><span class="p">()</span>
    <span class="n">last_week_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="n">now_wkday</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)).</span><span class="n">date</span><span class="p">()</span>
    <span class="n">last_week_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="n">now_wkday</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)).</span><span class="n">date</span><span class="p">()</span>

    <span class="n">m_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=-</span><span class="mi">1</span><span class="p">)).</span><span class="n">date</span><span class="p">()</span>
    <span class="n">last_month_start</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">m_1</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">m_1</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">last_month_end</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">m_1</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">m_1</span><span class="p">.</span><span class="n">month</span><span class="p">,</span>
                          <span class="n">calendar</span><span class="p">.</span><span class="n">monthrange</span><span class="p">(</span><span class="n">m_1</span><span class="p">.</span><span class="n">year</span><span class="p">,</span> <span class="n">m_1</span><span class="p">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">StartEndDates</span><span class="p">(</span><span class="n">last_week_start</span><span class="p">,</span> <span class="n">last_week_end</span><span class="p">,</span>
                         <span class="n">last_month_start</span><span class="p">,</span> <span class="n">last_month_end</span><span class="p">)</span>
</code></pre></div></div>

<p>In the scripts <code class="language-plaintext highlighter-rouge">dates_generator.py</code>, I created a class named <code class="language-plaintext highlighter-rouge">StartEndDates</code>
which contains the start date and end date for last week and last month,
respectively. I also created a function <code class="language-plaintext highlighter-rouge">start_end_dates()</code> who injects the 4
dates into the <code class="language-plaintext highlighter-rouge">StartEndDates</code> class.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># learn_unittest_mock/dates_generator_test.py
</span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">patch</span>

<span class="kn">import</span> <span class="nn">learn_unittest_mock.dates_generator</span> <span class="k">as</span> <span class="n">target</span>

<span class="n">d_20191231</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="n">d_20200101</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">d_20200302</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DatesGeneratorTest</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># mock datetime to control today's date
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span> <span class="o">=</span> <span class="n">patch</span><span class="p">(</span><span class="s">'learn_unittest_mock.dates_generator.datetime'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_20191231</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">d_20191231</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d_20191231</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">start_end_dates</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_end</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_20200101</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">d_20200101</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d_20200101</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">start_end_dates</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_end</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_20200302</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">d_20200302</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d_20200302</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">start_end_dates</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_week_end</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_start</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="n">res</span><span class="p">.</span><span class="n">last_month_end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">patcher</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="p">.</span><span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">dates_generator_test.py</code>, I firstly mock <code class="language-plaintext highlighter-rouge">datetime</code> then configure the
value of “<code class="language-plaintext highlighter-rouge">datetime.now</code>” with <code class="language-plaintext highlighter-rouge">return_value</code> and test if the dates are the same
as expectant。</p>

<h2 id="conclusion">Conclusion</h2>
<p>According to this blog, now you can:</p>
<ul>
  <li>understand what is mock and why we use mock</li>
  <li>use <code class="language-plaintext highlighter-rouge">unittest.mock</code> to simulate the behavior of complex or real objects</li>
  <li>configure your mock instance with <code class="language-plaintext highlighter-rouge">return_value</code> or / and <code class="language-plaintext highlighter-rouge">side_effect</code></li>
  <li>check how you called a method with assertions</li>
  <li>mock an object with <code class="language-plaintext highlighter-rouge">patch()</code></li>
</ul>

<h2 id="reference">Reference</h2>
<ul>
  <li>Alex Ronquillo, “Understanding the Python Mock Object Library”, <em>realpython.com</em>. [Online]. Available: <a href="https://realpython.com/python-mock-library/">https://realpython.com/python-mock-library/</a></li>
  <li>“unittest.mock — mock object library”, <em>docs.python.org</em>. [Online]. Available: <a href="https://docs.python.org/3/library/unittest.mock.html#">https://docs.python.org/3/library/unittest.mock.html#</a></li>
  <li>redshiftzero, “How to use Python’s unittest.mock.patch”, <em>www.youtube.com</em>. [Online]. Available: <a href="https://www.youtube.com/watch?v=WFRljVPHrkE&amp;t=345s">https://www.youtube.com/watch?v=WFRljVPHrkE&amp;t=345s</a></li>
  <li>“Mock object”, <em>en.wikipedia.org</em>. [Online]. Available: <a href="https://en.wikipedia.org/wiki/Mock_object">https://en.wikipedia.org/wiki/Mock_object</a></li>
  <li>“An introduction to mocking in python”, <em>bs-uploads.toptal.io</em>. [Online]. Available: <a href="https://bs-uploads.toptal.io/blackfish-uploads/blog/article/content/cover_image_file/cover_image/17606/cover-0402-an-introduction-to-mocking-in-python-Waldek_Newsletter-fdc7cce1eda95aee17e25b769a2bd183.png">https://bs-uploads.toptal.io/blackfish-uploads/blog/article/content/cover_image_file/cover_image/17606/cover-0402-an-introduction-to-mocking-in-python-Waldek_Newsletter-fdc7cce1eda95aee17e25b769a2bd183.png</a></li>
</ul>

</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2020-07-16T22:11:20+02:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="/feed.xml">Subscribe</a></div></div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Attribution-NonCommercial 4.0 International" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="/how-to-get-a-youtube-video-information-with-youtube-data-api-by-python/">How to get a YouTube video's information with YouTube Data API by Python?</a></div><div class="next"><span>NEXT</span><a href="/data-transformation-with-pandas-vs.-pyspark/">Data transformation with pandas vs. pyspark</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"><div id="disqus_thread"></div>
  <script>
  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  var disqus_config = function () {
    this.page.url = 'https://jingwen-z.github.io/how-to-apply-mock-with-python-unittest-module/';
    this.page.identifier = '/how-to-apply-mock-with-python-unittest-module';
  };
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://jingwen-z.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jingwen Zheng"><meta itemprop="url" content="/"><meta itemprop="description" content="Data Science Enthusiast"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/jingwen-zheng" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/jingwen-z" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Jingwen Zheng 2021,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script>
    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

